\documentclass{article}
\input{packages.tex}
\input{commands.tex}

\begin{document}
\section{Combined approximation}
The goal is to approximate $\u$ given $\K \u = \f$.

A reduced basis is generated using a previous factorization of $\K _0$. Let $\K = \K_0 + \delK$, then the equilibrium equations can be written as
\begin{equation}
    (\K _0 + \delK)\u = \f.
\end{equation}
A recurrence equation can be found by moving terms to the right-hand side
\begin{equation}
    \K _0 \u_{k + 1} = \f - \delK \u_k.
\end{equation}
Substitution gives $\u_{k + 1}$ in terms of $\u_1 = \K\i_0 \f$
\begin{equation}
    \u_{k + 1} = \bigg( \bm{I + \B + \B^2 + ... + \B^k}\bigg)\u_1, \ \text{where} \ \B = -\K\i_0 \delK.
\end{equation}
Thus, $\u$ can be expressed in the basis defined by
\[
\begin{cases}
    \bm \phi_1 = \K\i_0 \f \\
    \bm \phi_k = \K\i_0 \bm \delK \phi_{k-1}.
\end{cases}
\]
If the change in the matrix $\K$ is small (given by $\delK$), generating a small amount of basis vectors can yield an accurate approximation. Let $\Rb$ be the matrix consisting of the s first basis vectors, meaning $\Rb = (\bm{\phi_1, \; ..., \; \phi_s})$. The approximation can be expressed as $\Rb \Vec{y} = \tu$. Substitution into the equilibrium equation, and premultiplying by $\Rb^T$ from the left gives a reduces system of equations
\begin{equation}
    \Rb ^T \K \Rb \Vec{y} = \Rb^T \f.
\end{equation}

Since the basis vectors $\bm \phi_k$ may be almost parallel, orthogonalizing them can make the scheme more numerically stable. Furthermore, orthogonalizing with respect to the matrix $\K$ (meaning $\phat_i^T \K \phat_j = \delta_{ij}$) makes the system very easy to solve. Let $\Vb$ denote the orthogonal basis generated by the Gram-Schmidt scheme. The resulting system is given by
$$
\Vb ^T \K \Vb \Vec{z} = \Vb^T \f.
$$
Due to the orthogonalization the left-hand side reduces to the identity matrix, $\Vb ^T \K \Vb = \bm I$, and the approximation is given by
$$
\tu = \Vb \Vec{z} = \Vb \Vb^T \f.
$$

% Jämför med numerisk känslighet
% approximativ känslighet
% Kolla om materialmodellen funkar som det ska
% Eventuellt öka volymhalten
% Enkel approximation till känsligheten
% Oded

\section{Nonlinear FEM}
The displacements $\veca$ are found by solving the nonlinear system of equations
$$
\r = \fint(\z, \veca) - \fext = \zero.
$$
The stresses in the structure are given by the change in the strain energy with respect to the strain, or
$$
\vec{S} = \frac{\partial w}{\partial \vec{E}}.
$$
Discretizing the structure using finite elements, the internal forces in the structure are given by
$$
\fint = \int_\Omega \B^T \vec{S}dv.
$$
A Newton-Raphson scheme is used to iteratively solve for the displacements $\veca$,
$$
\K \dela_{k + 1}= -\r_{k}
$$
The displacements are then updated $\veca_{k + 1} = \veca_k + \dela_{k + 1}$.

\section{Line search}
It can be shown that the number of iterations in the solution scheme can be reduced by introducing line search. Instead of updating the displacements directly using the update $\bm a^i = \bm a^{i - 1} + \bm \Delta \bm a$, the increment in displacements is used as a search direction to find the next displacements $\bm a^i = \bm a^{i - 1} + \beta \bm \Delta \bm a$. Introduce the quantity $r(\beta) = \bm \Delta \bm a^T\bm r(\bm a^{i - 1} + \beta\bm \Delta \bm a)$. The residual is minimized if $\beta$ is chosen as
$$
\hat{\beta} = \frac{r(0)}{r(0) + r(1)}.
$$
Too large or small values of $\beta$ may cause issues, so in practice $\beta$ is chosen as
$$
\beta = \max\left(3, \ \min\left(0.3, \ \hat{\beta}\right)\right).
$$

\section{Optimization}
The end compliance can be used as a measure of the stiffness of the structure. If a displacement controlled scheme is used, maximizing the compliance results in a stiff structure.
$$
g_o = c = \bm \u_p^T\fintp.
$$
The design variables $\bm z$ are filtered using a density filter to prevent a checkerboard pattern, meaning $\z_f = \vec{M}_f\z$.
% The filtered design variables are projected onto [0, 1] using a Heaviside function which gives the densities $\bm \rho = H(\z_f)$.
A SIMP interpolation scheme gives elasticity modulus 
$$
E_e(\rho_e) = E_{min} + (E_{max} - E_{min})\rho_e^q,
$$
where q is usually chosen as 3.

A Neo-Hookean material model is used to model the structure, meaning the strain energy is given by
$$
w^{NH} = \frac{\kappa}{2}\bigg(\frac{1}{2}(J^2 - 1) - ln(J)\bigg) + \frac{1}{2}\mu \bigg(J^{-2/3}tr(\Vec{C}) - 3\bigg),
$$
where $J = \text{det}(\vec{F})$, $\vec{C}$ is the Cauchy-Green tensor $\vec{C} = \vec{F}^T \vec{F}$, $\kappa  = \frac{E}{3(1 - 2\nu)}$ is the bulk modulus, and $\mu = \frac{E}{2(1 + \nu)}$ is the shear modulus.

The strain energy is linear in the elasticity modulus $E_e(\rho_e)$, which is independent on the strain $\bm E$. This gives a very easy connection between the design variables and the internal forces, which can be evaluated choosing E = 1, and then multiplying by the interpolated elasticity modulus.
$$
(\fint)_e = E_e(\rho_e) \int_{V_e} \B^T \bm S^{NH}_e\big |_{E = 1}dV_e.
$$
The sensitivity of the forces with respect to the element density is thus
$$
\frac{d\boldsymbol{f}_{int, e}}{d\rho_e} = \frac{dE_e(\rho_e)}{d\rho_e}\int_{V_e} \B^T \bm S^{NH}_e\big |_{E = 1}dV_e.
$$
\subsection{Sensitivities}
Instead of computing the sensitivity of the goal function, an augmented goal function is analysed in order to reduce computational cost. Thus, consider the function
$$
\Tilde{g_0} = \bm \u_p^T\fintp + \bm \lambda^T\fintf.
$$
Assuming the structure is in equilibrium, this augmented goal function is identical to the original goal function. The sensitivity is given by
\begin{align*}
\frac{d \Tilde{g_0}}{dz_e} & = \u_p^T\left(\frac{\partial \fintp}{\partial z_e} + \frac{\partial \fintp}{\partial \u_f}\frac{\partial \u_f}{\partial z_e}\right) + \bm \lambda^T\bigg(\frac{d \fintf}{dz_e} + \frac{d \fintf}{d\bm \u_f}\frac{d\bm \u_f}{dz_e}\bigg) = \\ 
& = \u_p^T\frac{\partial \fintp}{\partial z_e} + \bm \lambda^T \frac{\partial \fintp}{\partial z_e} + \left(\bm \lambda^T\frac{d\fintf}{d\bm \u_p} + \u_p^T \frac{\partial \fintp}{\partial \u_f}\right)\frac{d\bm \u_f}{dz_e}.
\end{align*}
The derivative $\frac{d\bm \u_f}{dz_e}$ can be eliminated by asserting 
$$
\bm \lambda^T\frac{d\fintf}{d\bm \u_p} + \u_p \frac{\partial \fintp}{\partial \u_f} = \bm 0
$$
Using the notation $\frac{d\fintf}{d\u_f} = \bm K_{ff}$, and $\frac{d\fintp}{d\u_f} = \bm K_{fp}$ we have
\begin{align}
    & \frac{d\Tilde{g_0}}{dz_e} = \frac{d\fintf^T}{dz_e}\bm \lambda \nonumber \\
    & \bm K_{ff}\bm \lambda = -\bm K_{fp}\u_p. \label{eq:sens}
\end{align}
\section{Reusing information}
The idea of reusing information between optimization steps is what \textit{Combined Approximation} is based on. \textit{Combined Approximation} reuses information of the stiffness matrix from the previous step to speed up the solution of the non-linear system of residual equations, which is the most costly step in the optimization scheme as a whole. However, the change in design variables can also be used to find an initial guess to the increment in displacement. Expanding the residual equations in $\bm z$ and $\bm u$ we have
$$
\bm r_{f}(\bm z^{i}, \bm u^{i}) \approx \bm r_{f}(\bm z^{i-1}, \bm u^{i - 1}) + \frac{\partial \bm r^{i-1}_{f}}{\partial \bm z}\bm \Delta \bm z + \frac{\partial \bm r^{i-1}_{f}}{\partial \bm u_f}\bm \Delta \bm u_f.
$$
Assuming the residual equations are solved at the previous step $\bm r^{i-1} = \bm 0$, and asserting the residual equations are solved at the current step $\bm r^{i} = \bm 0$, an initial guess for the displacements can be found
$$
\frac{\partial \bm r^{i-1}_{f}}{\partial \bm u_f}\bm \Delta \bm u_f = -\frac{\partial \bm r^{i-1}_{f}}{\partial \bm z}\bm \Delta \bm z.
$$
Since the value of $\frac{\partial \bm r^{i-1}_{f}}{\partial \bm z}$ was computed in the evaluation of the sensitivities in the previous step, and the matrix $\frac{\partial \bm r^{i-1}_{f}}{\partial \bm u_f}$ has already been factorized and used in the iterative scheme, (or CA can be used to find a good approximation) this is very cheap to evaluate.
As we have discarded higher order terms, the accuracy depends on higher order derivatives and the the norm of $\bm z$, so in practice this initial guess of the displacement increment is only made if the norm of the change in design is small enough.
\section{Pseudocode}
\input{pseudocode}
\end{document}
